# 操作文档（气象预警邮件通知系统）

## 1. 适用对象
- 系统管理员
- 业务管理员
- 普通用户

## 2. 启动与访问
1. 在项目根目录运行：`python app.py`
2. 浏览器访问：`http://<服务器IP>:8000/login.html`

## 3. 首次初始化
### 3.1 创建管理员账号
系统默认不创建账号，请在初次部署后创建管理员账号：
- 方式一：调用接口
  - `POST /api/users`
  - 请求体示例：
    ```json
    {"username": "admin", "password": "your_password", "role": "admin"}
    ```
- 方式二：编辑 `user.json` 手动添加（不建议用于生产环境）

### 3.2 配置天气 API Key
- 在系统设置页面填写 `天气API密钥` 并保存。
- 或设置环境变量：`WEATHER_API_KEY`（优先级最高）。

### 3.3 配置 SMTP 邮箱
- 在设置页填写 SMTP 服务器、端口、发件人邮箱、账号与密码。
- 点击“测试邮件连接”验证可用性。

## 4. 管理员后台（admin.html）
### 4.1 用户账号管理
- 添加用户：填写用户名、密码与角色。
- 编辑用户：修改用户名/角色，密码可留空不变。
- 删除用户：删除后该用户无法登录。

### 4.2 修改管理员密码
- 输入当前密码、新密码与确认密码后保存。

## 5. 业务后台（index.html）
### 5.1 人员管理
- 新增人员：填写姓名/称呼/公司/邮箱/地区/关注天气类型。
- 编辑人员：更新联系方式或关注类型。
- 删除人员：删除后不再参与通知。
- 导入/导出：支持 Excel 模板导入与数据导出。

### 5.2 模板管理
- 新建模板：配置主题、正文、附件。
- 模板变量支持：
  - `{{name}}` 姓名
  - `{{title}}` 称呼
  - `{{company}}` 公司
  - `{{region}}` 地区
  - `{{date}}` 日期
  - `{{weather_type}}` 天气类型
  - `{{phone}}` 电话
  - `{{email}}` 邮箱

### 5.3 预警规则
- 参数型规则：如“最高温度 >= 35 度”。
- 文本型规则：如“包含 雷阵雨”。
- 可设置规则状态（启用/停用）。

### 5.4 通知中心
- 查看待处理通知。
- 审批通过：发送邮件并记录日志。
- 拒绝：记录拒绝原因。
- 自动审批：在设置中开启后自动发送。

### 5.5 日志管理
- 查看历史发送记录。
- 支持删除指定日志。

### 5.6 天气功能
- 城市搜索与默认城市查询。
- 收藏城市：添加/移除/刷新缓存。

### 5.7 系统设置
- SMTP/天气 API Key/预警时间与间隔配置。
- 需要变更后保存并生效。

## 6. 数据维护
- 数据库存储：`skyalert.db`
- 配置文件：`settings.json`
- 人员数据：`customers_data.json`
- 模板数据：`templates_data.json`
- 规则数据：`alert_rules.json`

## 7. 常见问题
- 天气接口报错：检查 `WEATHER_API_KEY` 是否配置。
- 邮件发送失败：检查 SMTP 账号与端口、邮箱授权码。
- 登录失败：确认用户存在于 `user.json` 中或通过接口创建。
