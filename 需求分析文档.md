# 需求分析文档（气象预警邮件通知系统）

## 版本信息
- 文档版本：V1.0
- 适用系统：天气预警邮件通知系统（学校版）
- 目标读者：产品负责人、研发、测试、运维、业务管理员

## 1. 背景与目标
### 1.1 背景
学校场景需要对高温、暴雨、台风等气象风险进行统一管理与通知，传统人工筛查与邮件发送存在延迟和遗漏风险。

### 1.2 目标
- 自动化拉取天气数据并生成预警通知。
- 统一管理人员、模板与预警规则，降低运维成本。
- 支持通知审批与日志可追溯，满足审计与复盘需求。

## 2. 范围说明
### 2.1 需求范围（做什么）
- 天气数据查询与预警判断。
- 人员管理与邮件通知。
- 模板管理、预警规则管理。
- 通知中心审批与日志管理。
- 系统设置与运行参数管理。

### 2.2 非需求范围（不做什么）
- 不提供短信/电话等多渠道通知（仅邮件）。
- 不提供复杂的审批流引擎（仅简单通过/拒绝）。
- 不包含实时地图可视化（仅列表与详情）。

## 3. 角色与权限
- 管理员：用户账号管理、系统设置、规则模板管理、审批与数据维护。
- 普通用户：查看预警、管理本角色相关数据（以页面权限为主）。
- 系统服务：定时拉取天气、执行规则判断与自动通知。

## 4. 业务流程
### 4.1 初始化流程
1. 部署服务并启动应用。
2. 配置天气 API Key、SMTP 邮件服务器参数。
3. 维护人员信息与关注的天气类型。
4. 配置模板与预警规则。

### 4.2 预警生成与发送
1. 系统按计划拉取天气数据。
2. 按预警规则匹配命中条件。
3. 使用模板生成通知内容。
4. 进入通知中心等待审批（或自动审批）。
5. 发送邮件并记录日志。

### 4.3 审批与日志
1. 管理员在通知中心查看待审批。
2. 审批通过后发送邮件并记录结果。
3. 可在日志中查询发送历史并支持删除。

## 5. 功能需求
### 5.1 账号与权限
- 登录、用户创建、编辑、删除、改密。
- 管理员与普通用户角色区分。

### 5.2 人员管理
- 人员信息增删改查。
- 支持导入与导出。
- 关注天气类型配置。

### 5.3 模板管理
- 模板增删改查。
- 支持附件上传、删除。
- 支持变量替换（如 `{{name}}`、`{{company}}` 等）。

### 5.4 预警规则
- 规则增删改查。
- 支持参数型规则（阈值比较）与文本型规则（关键词匹配）。

### 5.5 天气查询
- 城市搜索、默认城市、热门城市、收藏城市。
- 收藏城市的增删与缓存刷新。

### 5.6 通知中心
- 查看待处理通知。
- 审批、拒绝、自动审批。
- 清空待发送队列。

### 5.7 日志与追溯
- 查看发送日志。
- 按记录删除日志。

### 5.8 系统设置
- SMTP 配置、邮件署名。
- 预警时间、间隔、提前天数。
- 统一配置持久化与回写。

## 6. 数据需求
### 6.1 关键实体
- 人员（Personnel）：姓名、邮箱、地区、关注天气类型等。
- 模板（Template）：名称、主题、内容、附件。
- 规则（Alert Rule）：类型、条件、状态、触发方式。
- 通知（Notification）：通知内容、状态、关联邮件数据。
- 日志（Log）：发送结果、时间、收件人、天气类型。
- 设置（Setting）：SMTP、API Key、预警时间等。

### 6.2 数据保留
- 日志与通知可配置清理或定期归档。
- 不在仓库中保留个人数据与明文凭证。

## 7. 接口需求（摘要）
- 系统设置：`GET/POST /api/settings`
- 天气查询：`/api/weather/search`、`/api/weather/default`、`/api/weather/popular-cities`
- 收藏城市：`/api/weather/add-favorite`、`/api/weather/remove-favorite`、`/api/weather/get-favorites`
- 用户与登录：`/api/users`、`/api/login`
- 通知审批：`/api/notifications/<id>/approve`、`/api/notifications/<id>/reject`

## 8. 非功能需求
- 性能：一般接口响应 < 2 秒；天气拉取支持并发请求。
- 可用性：服务可用性 >= 99%；异常可恢复。
- 安全：敏感信息不硬编码；配置与凭证需脱敏。
- 可靠性：邮件发送失败应可重试并记录。
- 可维护性：配置与数据可导入导出。

## 9. 约束与假设
- 依赖外部天气 API 与 SMTP 服务可用。
- 服务器具备外网访问能力。
- 默认端口为 8000。

## 10. 风险与对策
- 天气 API 限流：增加缓存与失败降级逻辑。
- SMTP 认证失败：提供连接测试与错误提示。
- 数据误删：提供备份与导入工具。

## 11. 验收标准
- 所有核心功能可用并满足业务流程。
- 不包含企业/个人敏感信息与明文凭证。
- 可通过测试用例集与自测步骤。
